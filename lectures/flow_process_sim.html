<section>
    <h2><b>Process-based diffusion and flow simulation</b></h2>
    <p style="margin-top: 0.5em">
        Helena Mitasova, Anna Petrasova, Vaclav Petras</p>
    <p class="title-foot">
        GIS714 Geosimulations
        <a href="http://www.ncsu.edu/" title="North Carolina State University">NCSU</a>
    </p>
</section>

<section>
    <h3>Learning objectives</h3>
<p>
<ul>
   <li>diffusion process modeling
   <li>diffusion equation and its solutions
   <li>shallow water flow equation
   <li>numerical methods for solving SWFE
   <li>implementation
   <li>applications
</ul>
</section>

<section>
   <h3>Diffusion and flow </h3>
<p>Foundation of many geospatial models of natural and socioeconomic processes 
<ul>
<li class="fragment">diffusion in natural and socio-economic systems
<li class="fragment">flow in natural and socio-economic systems 
</ul>
<p class="fragment">diffusion and flow examples from Tobler to wind in real time
<img height="250" src="img/intro/apex_dry_white.png">
<img height="250" src="img/diffusion_flows/Tobler_govfiscal.jpg">
<p><small>Images from Laura Pagano and Waldo Tobler presentations</small>
</section>

<section>
   <h3>Duality of particles and fields</h3>
<p>Modeled quantities can be represented by
<ul>
  <li>fields - continuous distribution (scalar, vector, tensor)
  <li>particles - discrete distribution
</ul>
<p>Transformation between the two representations:
<p>distributed particles - particle density function - field $f(r)$
<p>field $f(r)$ - sampling with density $f(r)$ - particle representation
</section>

<section>
   <h3>Duality of particles and fields</h3>
<p>Process can be modeled as
<ul>
  <li>evolution of fields
  <li>evolution of spatially distributed particles
</ul>
<p>Path sampling method uses this duality to solve the governing equations
</section>

<section>
   <h3>Duality of particles and fields</h3>
<p>
<img height="300" src="img/diffusion_flows/fanimwalk.gif">
<img height="300" src="img/diffusion_flows/fanimhhcolp.gif">
</section>

<section>
   <h3>Path sampling method</h3>
<p>Method for solving linear partial differential equations developed in physics, used also in chemistry, finance
<p> Governing  equation: $L(c) = S$
<p>S is sources-sinks, c is the modeled quantity, L is the operator e.g.,diffusion+ flow/drift + proliferation/decay
<p> Solution: $c = L^{-1} (S)$,  $L^{-1}$ is the inverse operator
<p>sample the source term field simulate action of L-1 on S estimate c from the density
</section>

<section>
   <h3>Diffusion</h3>
<p>Fick's law + mass conservation law lead to diffusion equation
<p>Alternatively, random walks densities evolution is used to derive diffusion equation
<p><small>some definitions
<ul>
<li>flux : rate of mass transport across unit point, line, or area depending on dimension
<li>density gradient: change in density (concentration?)
<li>Fick's law: flux (of particles, material) at a given location is proportional 
to local change (gradient) of (particle) density (or material concentration?)
</ul>
</small>
</section>

<section>
   <h3>Diffusion equation</h3>
<p>
<ul>
<li>
<ul>
<li class="fragment">Fick's law (flux is a function of density gradient, empirical observation) - in 1D:
<p>
$$ f(x,t) = -D_0 {\partial n(x,t) \over \partial x}$$ 
<p>
<li class="fragment"> Continuity equation (mass preservation: change in density at any location is equal 
to the inflow and outflow of particles (material) at this location
<p>
$$ {\partial n(x,t) \over \partial t} + {\partial f(x,t) \over \partial x} = 0 $$
<p>
<li class="fragment"> Diffusion equation 
<p>
$$ {\partial n(x,t) \over \partial t} = D_0 {\partial^2 n(x,t) \over \partial x^2} $$
</ul>
<li>
<ul>
<li>$f(x,t)$ is flux
<li>$n(x,t)$ is density
<li>$x$ is location and $t$ is time
</ul>
</ul>
<!--
see also https://en.wikipedia.org/wiki/Diffusion_equation
$$ \nabla f = \left( {\partial f \over \partial x}, {\partial f \over \partial y} \right) = (f_x, f_y)$$
<p>
 <li class="fragment">where $f_x, f_y$ are partial derivatives of $f(x,y)
 <li class="fragment"> $\nabla f$ is a vector in the direction of largest increase in $z$.  
-->
</section>

<section>
   <h3>Diffusion: numerical modeling</h3>
<!--
<p>
<ul>
 <li>$- \nabla f$ is a vector in the steepest slope direction (aspect),
  its magnitude is slope steepness (rise over run).
<p>
 <li class="fragment">slope $\beta$ and aspect $\alpha$: 
<p>
$$\beta^\circ = {\arctan}\sqrt{f_x^2+f_y^2} \qquad \beta\%=100 \sqrt{f_x^2+f_y^2}$$
$$\alpha^\circ = {\arccos} \left( -f_y \over \sqrt{f_x^2+f_y^2} \right) $$
<li class="fragment">we can compute gradient using slope and aspect angle 
<p>
$$ f_x = \tan \beta . \cos \alpha, \qquad f_y = \tan \beta . \sin \alpha$$
</ul>
<p>
<small>recall that 
$$(f_x, f_y) = \left( {\partial f \over \partial x}, {\partial f \over \partial y} \right), \; z = f(x,y)$$
</small>
-->
</section>

<section>
   <h3>Diffusion example</h3>
<!--
<p>
<ul>
  <li class="fragment">D8: $\Delta z_{max}$ in 3x3 window: 
  discrete directions 0,45, deg 
<p>
  <li class="fragment">Dinf: partial derivatives of a suitable approximation function, such as spline or polynomial
</ul>
<p class="fragment"> <small>Fitting the polynomial bellow to the 9 grid points of 3x3 window
using weighted least squares leads to simple equations for estimating $f_x, f_y$:
<p class="fragment">
$$z(x,y)=a_0+a_1 x + a_2 y + a_3 xy + a_4 x^2 + a_5 y^2$$
<p class="fragment">
$$f_x={{(z_{i-1,j-1}-z_{i+1,j-1})+2(z_{i-1,j}-z_{i+1,j})+(z_{i-1,j+1}-z_{i+1,j+1})} \over {8\Delta x}}$$
<p class="fragment">
$$f_y={{(z_{i-1,j-1}-z_{i-1,j+1})+2(z_{i,j-1}-z_{i,j+1})+(z_{i+1,j-1}-z_{i+1,j+1})} \over {8\Delta y}}$$
</small>
<p> <img height="120" src="img/water_geometry/3x3window_zij.png">
-->
</section>

<section>
   <h3>Shallow water flow equation</h3>
<ul>
<li>processes modeled by SWF equation: 
<p>
   <ul>
   <li class="fragment">overland flow (approx, and full difusive wave) 
   <li class="fragment">dam breach flooding
   <li class="fragment">storm surge
   <li class="fragment">sediment and debris flow
   </ul>
<p class="fragment"> processes modeled by SWF - photos or simulations
<img height="300" src="img/water_geometry/rflowfigure.jpg">
</section>

<section>
   <h3>Shallow water flow equation</h3>
<p>bivariate form of the St Venant equation
<p>
 $$ {\partial h({\bf r},t) \over \partial t} = i_e({\bf r},t) - \nabla \cdot {\bf q}({\bf r},t)$$
<p>momentum conservation in the diffusion wave approximation:
$$ {\bf s_f}({\bf r},t)={\bf s}({\bf r})-\nabla h({\bf r},t)$$
<small>
<ul>
 <li>${\bf r}=(x,y)$ [m] is the position,
 <li>$t$ [s] is the time,
 <li>$h({\bf r},t)$ [m] is the depth of overland flow,
 <li>$i_e({\bf r},t)$ [m/s] is the rainfall excess = (rainfall $-$ infiltration $-$ vegetation intercept) [m/s],
 <li>${\bf q}({\bf r},t)$ [$\rm m^2/s$] is the water flow per unit width,
 <li>${\bf s}({\bf r})= - \nabla z({\bf r})$ is the negative elevation gradient,
 <li>$z({\bf r})$ [m] is the elevation,
 <li>and ${\bf s_f}({\bf r},t)$ is the negative gradient of overland flow surface (friction slope).
</ul>
</small>
</section>

<section>
   <h3>Shallow water flow equation</h3>
<p>hydraulic radius is approximated by flow depth $h({\bf r},t)$ and the unit discharge is given by:

$${\bf q}({\bf r},t)={\bf v}({\bf r},t) h({\bf r},t)$$

<p>${\bf v}({\bf r},t)$  [m/s] is the flow velocity.
<p>The system of equations is closed using the Manning's relation  

$${\bf v}({\bf r},t)= {C\over n({\bf r})} h({\bf r},t)^{2/3} |{\bf s_f}({\bf r},t)|^{1/2} {\bf s_{f0}({\bf r},t)}$$
<ul>
<li>$n({\bf r}) $ is the dimensionless Manning's coefficient,
<li>C=1$ [$m^{1/3}/s$] is the corresponding dimension constant 
<li>${\bf s_{f0}}({\bf r})={\bf s_f}({\bf r})/|{\bf s_f}({\bf r})|$
is the unit vector in the friction slope direction.
</section>

<section>
   <h3>SWF numerical methods</h3>
<ul>
<li>finite difference, finite element
<li> finite volume
<li> QMC path sampling 
</ul>
<p>images illustrating approaches
<p><img height="280" src="img/water_geometry/rflowfigure.jpg">
<img height="280" src="img/water_geometry/flowlines_and_contours.png">
</section>

<section>
   <h3>SWF simplified</h3>
Solution of continuity and momentum equations for
a steady water flow that is close to kinematic wave approximation
</section>

<section>
   <h3>Duality of particles and fields</h3>
<p>Modeled quantities can be represented by
<ul>
  <li>fields - continuous distribution (scalar, vector, tensor) 
  <li>particles - discrete distribution
</ul>
<p>Transformation between the two representations:
<p>distributed particles - particle density function - field $f(r)$ 
<p>field $f(r)$ - sampling with density $f(r)$ - particle representation
</section>

<section>
   <h3>Duality of particles and fields</h3>
<p>Process can be modeled as
<ul>
  <li>evolution of fields 
  <li>evolution of spatially distributed particles 
</ul>
<p>Path sampling method uses this duality to solve the governing equations
</section>

<section>
   <h3>Path sampling method</h3>
<p>Method for solving linear partial differential equations developed in physics, used also in chemistry, finance
<p> Governing  equation: $L(c) = S$ 
<p>S is sources-sinks, c is the modeled quantity, L is the operator e.g.,diffusion+ flow/drift + proliferation/decay
<p> Solution: $c = L^{-1} (S)$,  $L^{-1}$ is the inverse operator
<p>sample the source term field simulate action of L-1 on S estimate c from the density
<img height="160" src="img/water_geometry/accum5K_gr65_feb10b.jpg">
</section>

<!--add equations later on-->
<section>
   <h3>Green's function solution</h3>
<p>MFD multiple flow direction partitions flow into two or more downslope directions
<p>
<p class="fragment">
<!--<img height="350" src="img/water_geometry/flowdispersal.jpg">-->
<img height="360" src="img/water_geometry/accum5K_gr65_feb10b.jpg">
<img height="360" src="img/water_geometry/accum5K_gr65_mfd.jpg">
</section>

<section>
   <h3>Path sampling method: accuracy and properties</h3>
<p>Error is proportional to the $1/\sqrt N$, where N is the number of particles
<p>
<img height="300" src="img/diffusion_flows/mcsf_steady.gif">
<img height="300" src="img/diffusion_flows/mcsf3_steady.gif">
</section>

<section>
   <h3>Path sampling method: accuracy and properties</h3>
<p>Error is proportional to the $1/\sqrt N$, where N is the number of particles
<p>
<img height="360" src="img/diffusion_flows/mcsimwelg.gif">
</section>

<section>
   <h3>Multiscale implementation</h3>
<p>Path sampling enables implementation with multiple resolutions by adjusting
the weight of the particles
<p class="fragment">
<img height="320" src="img/diffusion_flows/mcwc.gif">
<img height="320" src="img/diffusion_flows/multiscale_hohen.jpg">
</section>

<section>
   <h3>Implementation and parallelization</h3>
<p>Simulation of spatialy variable source areas
<p class="fragment">
<img height="350" src="img/diffusion_flows/accum_runoffuni_30m3d.jpg">
<img height="350" src="img/diffusion_flows/accum_runoffvar_30m3d.jpg">
</section>

<section>
   <h3>Urban flooding</h3>
<ul>
<li>simplified shallow water flow equation with dynamic input
<li>coupled with 1D flow (SWWM) through stormwater infrastructure
</ul>
<p class="fragment">
<img height="280" src="img/diffusion_flows/depressionfill_scheme.png">
</section>

<section>
   <h3>Finite volume solution</h3>
Dam breach model - full diffusive wave solution with backwater effect
<!--<p><img height="380" src="img/diffusion_flows/sim3_ortho.gif">-->
</section>

<section>
   <h3>ADCIRC equations </h3>
(from the exam)
</section>

<section>
   <h3>Visualization</h3>
<ul>
<li>2D animation over orthophoto
<li>3D animation: dynamic color map over static elevation surface
<li>3D animation as dynamic water surface over static elevation surface
<li>3D animation as dynamic water surface for visual analysis (e.g. steady state)
</ul>
<p>
<img height="280" src="img/water_geometry/floodedarea.jpg">
<img height="280" src="img/water_geometry/lakeflood_swwake_streets.jpg">
<p><small>water level at 90m asl</small>
</section>

<section>
   <h3>Applications</h3>
<ul>
<li>What is gradient in flat area? In depressions?
<li>Many algorithms were developed for routing through flat areas and depressions
<li>Hydrological flattening, enforcement, conditioning
<li>New (and some old) algorithms do not require depression filled DEM
</ul>
<p class="fragment">
<img height="280" src="img/water_geometry/depressionfill_scheme.png">
</section>




<!--
<section>
 <h3>Summary</h3>
<ul>
<li>we have defined types of models
</ul>
</section>

<section>
 <h3>Reading, resources</h3>
links
</section>
-->

<div class="parent-page">
    <!-- &#x1f3e0; -->
    <a href="http://ncsu-geoforall-lab.github.io/geospatial-simulations-course/" title="Go to the course page">&#8962;</a>
</div>



